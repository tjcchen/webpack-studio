{"version":3,"sources":["../src/HtmlWebpackExternalsPlugin.js"],"names":["HtmlWebpackExternalsPlugin","config","validateArguments","assetsToPrepend","assetsToAppend","assetsToCopy","externals","hash","outputPath","publicPath","files","enabled","forEach","module","entry","global","supplements","append","localEntries","entries","Array","isArray","map","path","type","undefined","URL_ENTRY","test","localEntry","push","asset","compiler","options","output","pluginsToApply","from","to","createAssetsPlugin","assets","length","plugin","apply","ajv","useDefaults","removeAdditional","validateConfig","compile","TypeError","errorsText","errors"],"mappings":"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","file":"HtmlWebpackExternalsPlugin.js","sourcesContent":["import CopyWebpackPlugin from 'copy-webpack-plugin'\nimport HtmlWebpackIncludeAssetsPlugin from 'html-webpack-include-assets-plugin'\nimport Ajv from 'ajv'\nimport configSchema from './configSchema.json'\n\nexport default class HtmlWebpackExternalsPlugin {\n  static validateArguments = (() => {\n    const ajv = new Ajv({ useDefaults: true, removeAdditional: true })\n    const validateConfig = ajv.compile(configSchema)\n\n    return config => {\n      if (!validateConfig(config)) {\n        throw new TypeError(ajv.errorsText(validateConfig.errors))\n      }\n    }\n  })()\n\n  static URL_ENTRY = /^(http:|https:)?\\/\\//\n\n  constructor(config) {\n    HtmlWebpackExternalsPlugin.validateArguments(config)\n\n    this.assetsToPrepend = []\n    this.assetsToAppend = []\n    this.assetsToCopy = []\n    this.externals = {}\n\n    const { externals, hash, outputPath, publicPath, files, enabled } = config\n    this.hash = hash\n    this.outputPath = outputPath\n    this.publicPath = publicPath\n    this.files = files\n    this.enabled = enabled\n\n    externals.forEach(({ module, entry, global, supplements, append }) => {\n      this.externals[module] = global\n\n      const localEntries = []\n\n      const entries = (Array.isArray(entry) ? entry : [entry]).map(entry => {\n        if (typeof entry === 'string') {\n          entry = { path: entry, type: undefined }\n        }\n        if (HtmlWebpackExternalsPlugin.URL_ENTRY.test(entry.path)) {\n          return entry\n        }\n        const localEntry = `${module}/${entry.path}`\n        localEntries.push(localEntry)\n        return { ...entry, path: localEntry }\n      })\n\n      if (append) {\n        this.assetsToAppend = [...this.assetsToAppend, ...entries]\n      } else {\n        this.assetsToPrepend = [...this.assetsToPrepend, ...entries]\n      }\n\n      this.assetsToCopy = [\n        ...this.assetsToCopy,\n        ...localEntries,\n        ...supplements.map(asset => `${module}/${asset}`),\n      ]\n    })\n  }\n\n  apply(compiler) {\n    if (!this.enabled) {\n      return\n    }\n\n    if (!compiler.options.externals) {\n      compiler.options.externals = this.externals\n    } else if (Array.isArray(compiler.options.externals)) {\n      compiler.options.externals.push(this.externals)\n    } else if (typeof compiler.options.externals === 'object') {\n      compiler.options.externals = {\n        ...compiler.options.externals,\n        ...this.externals,\n      }\n    }\n\n    const publicPath = (() => {\n      if (this.publicPath != null) {\n        return this.publicPath\n      } else if (compiler.options.output.publicPath != null) {\n        return compiler.options.output.publicPath\n      } else {\n        return ''\n      }\n    })()\n\n    const pluginsToApply = []\n\n    pluginsToApply.push(\n      new CopyWebpackPlugin(\n        this.assetsToCopy.map(asset => ({\n          from: `node_modules/${asset}`,\n          to: `${this.outputPath}/${asset}`,\n        }))\n      )\n    )\n\n    const createAssetsPlugin = (assets, append) => {\n      if (assets.length) {\n        pluginsToApply.push(\n          new HtmlWebpackIncludeAssetsPlugin({\n            assets: assets.map(\n              asset =>\n                HtmlWebpackExternalsPlugin.URL_ENTRY.test(asset.path)\n                  ? asset\n                  : {\n                      ...asset,\n                      path: `${publicPath}${this.outputPath}/${asset.path}`,\n                    }\n            ),\n            append,\n            hash: this.hash,\n            files: this.files == null ? undefined : this.files,\n            publicPath: '',\n          })\n        )\n      }\n    }\n\n    createAssetsPlugin(this.assetsToPrepend, false)\n    createAssetsPlugin(this.assetsToAppend, true)\n\n    pluginsToApply.forEach(plugin => plugin.apply(compiler))\n  }\n}\n"]}